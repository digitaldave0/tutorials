AWSTemplateFormatVersion: 2010-09-09
Description: "Create s3 bucket with autogenerated name"

Conditions:

  IsServiceCatalogDeployment:
    !Equals
      - !Select
        - 0
        - !Split
          - '-'
          - !Ref AWS::StackName
      - SC

Resources:  
  daves3bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
         !If
          - IsServiceCatalogDeployment
          - !Sub '${AWS::AccountId}-${AWS::Region}-callerid'
          - !Sub '${AWS::AccountId}-${AWS::StackName}-callerid'
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: bucketname
          Value: !Sub '${AWS::AccountId}-${AWS::StackName}-callerid'

  davesbucketpolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Sub '${AWS::AccountId}-${AWS::StackName}-callerid'
      PolicyDocument:
        Statement:
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action:
              - 's3:*'
            Resource:
              - !Join 
                - ''
                - - 'arn:aws:s3:::'
                  - !Sub '${AWS::AccountId}-${AWS::StackName}-callerid'
              - !Join 
                - ''
                - - 'arn:aws:s3:::'
                  - !Sub '${AWS::AccountId}-${AWS::StackName}-callerid'
                  - /*
Outputs:
  daves3bucket:
    Value: !Ref daves3bucket
    Description: S3 Bucket for object storage
  davesbucketpolicy:
    Value: !Ref davesbucketpolicy